name: Ping Supabase Database

on:
  # Run once to start the cycle
  workflow_dispatch:
  # Schedule to run every 3 days
  schedule:
    - cron: '0 0 */3 * *'  # At 00:00 UTC every 3 days

jobs:
  ping-database:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm install @supabase/supabase-js
      
      - name: Ping Supabase database
        run: |
          node -e "
            const { createClient } = require('@supabase/supabase-js');
            
            // Initialize Supabase client
            const supabaseUrl = '${{ secrets.SUPABASE_URL }}';
            const supabaseKey = '${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}';
            const supabase = createClient(supabaseUrl, supabaseKey);
            
            async function pingDatabase() {
              try {
                // Simple query to check connection
                const { data, error } = await supabase.from('ping_log').insert([
                  { pinged_at: new Date().toISOString() }
                ]);
                
                if (error) {
                  console.error('Error pinging database:', error);
                  process.exit(1);
                }
                
                console.log('Successfully pinged database at', new Date().toISOString());
              } catch (error) {
                console.error('Exception while pinging database:', error);
                process.exit(1);
              }
            }
            
            pingDatabase();
          "
      
      - name: Log ping status
        run: echo "Supabase ping completed at $(date)"
